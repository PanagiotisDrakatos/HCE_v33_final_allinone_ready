name: CI

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PYTHONUNBUFFERED: 1
  # For GitHub runs: Settings → Variables → RUN_BACKTESTS="1" to enable
  RUN_BACKTESTS: ${{ vars.RUN_BACKTESTS || '0' }}

jobs:
  # ───────────────────────── Ruff Lint ─────────────────────────
  lint:
    name: Ruff Lint & Format (check)
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      # act runners may not have node; GH runners do. Install only on act.
      - name: Ensure Node (act only)
        if: ${{ env.ACT == 'true' }}
        run: |
          apt-get update
          apt-get install -y nodejs npm
          node -v && npm -v

      - uses: actions/checkout@v4

      # New: set git identity for any git operations
      - name: Set git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      # Replace setup-python with verifying the system Python
      - name: System Python info
        run: |
          set -euxo pipefail
          python3 -V
          which python3

      # New: fix SSL on both act and GH runners before any pip/network ops
      - name: Fix SSL (for act and GH)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libssl3 ca-certificates
          sudo update-ca-certificates || true

      - name: Cache Ruff
        if: ${{ env.ACT != 'true' }}
        uses: actions/cache@v4
        with:
          path: .ruff_cache
          key: ${{ runner.os }}-ruff-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-ruff-

      - name: Install Ruff in venv (PEP 668-safe, with ensurepip fallback)
        run: |
          set -euxo pipefail
          python3 -m venv .venv || true
          if [ ! -x ".venv/bin/pip" ]; then
            echo "⚠️  pip not found in venv — bootstrapping with ensurepip"
            python3 -m venv .venv --without-pip
            .venv/bin/python -m ensurepip --default-pip
          fi
          .venv/bin/python -m pip install --upgrade pip setuptools wheel
          .venv/bin/python -m pip install "ruff>=0.4.10"
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
      

      - name: Ruff check
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          (ruff check --output-format=github --force-exclude . 2>&1 | tee ci_logs/ruff-check.txt)

      - name: Ruff format (check only)
        run: |
          set -euxo pipefail
          (ruff format --check . 2>&1 | tee ci_logs/ruff-format-check.txt)

      - name: Upload lint logs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-lint
          path: ci_logs/

  # ───────────────────────── Unit Tests ─────────────────────────
  tests:
    name: Unit Tests
    runs-on: ubuntu-24.04
    needs: [ lint ]
    timeout-minutes: 25
    steps:
      - name: Ensure Node (act only)
        if: ${{ env.ACT == 'true' }}
        run: |
          apt-get update
          apt-get install -y nodejs npm
          node -v && npm -v

      - uses: actions/checkout@v4

      # New: set git identity for any git operations
      - name: Set git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      # Replace setup-python with verifying the system Python
      - name: System Python info
        run: |
          set -euxo pipefail
          python3 -V
          which python3

      # Replaced: fix SSL on both act and GH runners
      - name: Fix SSL (for act and GH)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libssl3 ca-certificates
          sudo update-ca-certificates || true

      - name: Install deps (venv)
        run: |
          set -euxo pipefail
          python3 -m venv .venv
          .venv/bin/pip install -U pip setuptools wheel
          if [ -f requirements.txt ]; then .venv/bin/pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then .venv/bin/pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then .venv/bin/pip install -e .; fi
          .venv/bin/pip install pytest pytest-cov

      - name: Run pytest (with coverage)
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          (.venv/bin/pytest -q --cov=. --cov-report=xml --cov-report=term 2>&1 | tee ci_logs/pytest.txt)

      - name: Upload test outputs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-tests
          path: |
            ci_logs/
            coverage.xml

  # ───────────────────────── PR Guard ─────────────────────────
  pr-guard:
    name: PR Guard (merge/conflicts/policy)
    runs-on: ubuntu-24.04
    needs: [ lint ]
    timeout-minutes: 8
    steps:
      - name: Ensure Node (act only)
        if: ${{ env.ACT == 'true' }}
        run: |
          apt-get update
          apt-get install -y nodejs npm
          node -v && npm -v

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # New: set git identity for any git operations
      - name: Set git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      # New: ensure system has updated CA certs for fetch/merge over HTTPS
      - name: Fix SSL (for act and GH)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libssl3 ca-certificates
          sudo update-ca-certificates || true

      - name: Ensure PR merges cleanly into base
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          echo "Base: $GITHUB_BASE_REF  Head: $GITHUB_HEAD_REF" | tee ci_logs/pr-guard.merge.txt
          git fetch origin "$GITHUB_BASE_REF" "$GITHUB_HEAD_REF"
          git checkout -b pr-merge-test "origin/$GITHUB_BASE_REF"
          if ! git merge --no-commit --no-ff "origin/$GITHUB_HEAD_REF"; then
            echo "::error::PR cannot be merged cleanly into ${GITHUB_BASE_REF}. Please rebase." | tee -a ci_logs/pr-guard.merge.txt
            exit 1
          fi
          echo "✅ Clean merge test passed." | tee -a ci_logs/pr-guard.merge.txt

      - name: Check branch is not behind base
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          git fetch origin "$GITHUB_BASE_REF"
          BEHIND=$(git rev-list --count HEAD.."origin/$GITHUB_BASE_REF")
          if [ "$BEHIND" -gt 0 ]; then
            echo "::error::Branch is $BEHIND commits behind ${GITHUB_BASE_REF}. Please rebase/merge." | tee ci_logs/pr-guard.behind.txt
            exit 1
          fi
          echo "✅ Branch is up to date with base." | tee ci_logs/pr-guard.behind.txt

      - name: Disallow merge commits in PR history
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          git fetch origin "$GITHUB_BASE_REF"
          MERGES=$(git rev-list --merges --count "origin/$GITHUB_BASE_REF"..HEAD)
          if [ "$MERGES" -gt 0 ]; then
            echo "::error::PR contains merge commits. Please rebase on ${GITHUB_BASE_REF}." | tee ci_logs/pr-guard.merges.txt
            exit 1
          fi
          echo "✅ No merge commits in PR history." | tee ci_logs/pr-guard.merges.txt

      - name: Forbid Windows-only files & non-Ruff linters
        run: |
          set -euxo pipefail
          mkdir -p ci_logs
          # Disallow Windows-only scripts in the repo
          if git ls-files -z | grep -E -z '\\.(cmd|bat|ps1)$'; then
            echo "::error::Windows-only scripts (*.cmd|*.bat|*.ps1) are not allowed." | tee ci_logs/pr-guard.policy.txt
            exit 1
          fi

          # 1) Fail fast on explicit forbidden config files in the repo
          if git ls-files | grep -Eq '(^|/)(\\.flake8|pylintrc|pylint\\.ini|\\.pylintrc|black\\.toml)$'; then
            echo "::error::Found disallowed config files (black/flake8/pylint). Use Ruff only." | tee -a ci_logs/pr-guard.policy.txt
            exit 1
          fi

          # 2) If pyproject.toml exists, only fail if it contains explicit black/flake8/pylint sections
          if git ls-files --error-unmatch pyproject.toml >/dev/null 2>&1; then
            if grep -nE '^\\[tool\\.(black|flake8|pylint)\\]' pyproject.toml >/dev/null 2>&1; then
              echo "::error::pyproject.toml contains black/flake8/pylint tool config. Use Ruff only." | tee -a ci_logs/pr-guard.policy.txt
              exit 1
            fi
          fi

          # 3) Heuristic grep for explicit mentions that likely indicate usage — skip docs/scripts/.github/pyproject
          if git grep -nE '\\b(black|flake8|pylint|isort)\\b' -- . ':(exclude)README*' ':(exclude)*.md' ':(exclude)pyproject.toml' ':(exclude)scripts/**' ':(exclude).github/**' ; then
            echo "::error::Found disallowed linters/configs (black/flake8/pylint/isort). Use Ruff only." | tee -a ci_logs/pr-guard.policy.txt
            exit 1
          fi

          echo "✅ Policy checks passed." | tee -a ci_logs/pr-guard.policy.txt

      - name: Upload PR-Guard logs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-pr-guard
          path: ci_logs/

  # ───────────────────────── Backtests (optional) ─────────────────────────
  backtests:
    name: Backtests (optional)
    runs-on: ubuntu-24.04
    needs: [ tests ]
    timeout-minutes: 60
    steps:
      - name: Ensure Node (act only)
        if: ${{ env.ACT == 'true' }}
        run: |
          apt-get update
          apt-get install -y nodejs npm
          node -v && npm -v

      - uses: actions/checkout@v4

      # New: set git identity for any git operations
      - name: Set git user
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      # Replace setup-python with verifying the system Python
      - name: System Python info
        run: |
          set -euxo pipefail
          python3 -V
          which python3

      # Replaced: fix SSL on both act and GH runners
      - name: Fix SSL (for act and GH)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libssl3 ca-certificates
          sudo update-ca-certificates || true

      - name: Install deps (venv)
        run: |
          set -euxo pipefail
          python3 -m venv .venv
          .venv/bin/pip install -U pip setuptools wheel
          if [ -f requirements.txt ]; then .venv/bin/pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then .venv/bin/pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then .venv/bin/pip install -e .; fi
          .venv/bin/pip install pytest pytest-cov

      # For backtests, install additional dependencies if present
      - name: Install backtest dependencies
        run: |
          set -euxo pipefail
          if [ -f requirements-backtest.txt ]; then .venv/bin/pip install -r requirements-backtest.txt; fi

      # Only run backtests if enabled
      - name: Run backtests
        if: ${{ env.RUN_BACKTESTS == '1' }}
        run: |
          set -euxo pipefail
          mkdir -p ci_logs/backtests
          echo "Backtests would run here. Provide a runner or script if needed." | tee ci_logs/backtests/backtest_results.txt
          # Example placeholder: .venv/bin/python -m backtest_runner -q --output-dir ci_logs/backtests

      - name: Upload backtest outputs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-backtests
          path: ci_logs/backtests/
